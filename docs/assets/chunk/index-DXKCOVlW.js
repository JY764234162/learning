import{r as m,I as b,j as e,T as N,B as C}from"../../main-CRe4Yinv.js";import{F as h}from"./index-BSBafhyI.js";import{C as T}from"./index-B9SH_yGS.js";import{R as U}from"./DisconnectOutlined-C82ru34q.js";import{S as $}from"./index-Dnivcq-t.js";import{I as E}from"./index-s8IvnVg3.js";import{R as M}from"./SendOutlined-BW5amPfB.js";import{A}from"./index-DjYIjjO3.js";import"./useForm-BoVeYjXd.js";import"./row-CiOWDV5P.js";import"./index-Dut9ob2r.js";import"./useBreakpoint--HSaInQU.js";import"./useForceUpdate-j9ZvleN1.js";import"./ExclamationCircleFilled-nbeej0ms.js";import"./Input-Dg67YJi7.js";import"./EyeOutlined-hs1Ju4mR.js";import"./SearchOutlined-CaxMxbev.js";import"./index-epmxyOvs.js";var F={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M909.1 209.3l-56.4 44.1C775.8 155.1 656.2 92 521.9 92 290 92 102.3 279.5 102 511.5 101.7 743.7 289.8 932 521.9 932c181.3 0 335.8-115 394.6-276.1 1.5-4.2-.7-8.9-4.9-10.3l-56.7-19.5a8 8 0 00-10.1 4.8c-1.8 5-3.8 10-5.9 14.9-17.3 41-42.1 77.8-73.7 109.4A344.77 344.77 0 01655.9 829c-42.3 17.9-87.4 27-133.8 27-46.5 0-91.5-9.1-133.8-27A341.5 341.5 0 01279 755.2a342.16 342.16 0 01-73.7-109.4c-17.9-42.4-27-87.4-27-133.9s9.1-91.5 27-133.9c17.3-41 42.1-77.8 73.7-109.4 31.6-31.6 68.4-56.4 109.3-73.8 42.3-17.9 87.4-27 133.8-27 46.5 0 91.5 9.1 133.8 27a341.5 341.5 0 01109.3 73.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.6 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c-.1-6.6-7.8-10.3-13-6.2z"}}]},name:"reload",theme:"outlined"},P={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M858.5 763.6a374 374 0 00-80.6-119.5 375.63 375.63 0 00-119.5-80.6c-.4-.2-.8-.3-1.2-.5C719.5 518 760 444.7 760 362c0-137-111-248-248-248S264 225 264 362c0 82.7 40.5 156 102.8 201.1-.4.2-.8.3-1.2.5-44.8 18.9-85 46-119.5 80.6a375.63 375.63 0 00-80.6 119.5A371.7 371.7 0 00136 901.8a8 8 0 008 8.2h60c4.4 0 7.9-3.5 8-7.8 2-77.2 33-149.5 87.8-204.3 56.7-56.7 132-87.9 212.2-87.9s155.5 31.2 212.2 87.9C779 752.7 810 825 812 902.2c.1 4.4 3.6 7.8 8 7.8h60a8 8 0 008-8.2c-1-47.8-10.9-94.3-29.5-138.2zM512 534c-45.9 0-89.1-17.9-121.6-50.4S340 407.9 340 362c0-45.9 17.9-89.1 50.4-121.6S466.1 190 512 190s89.1 17.9 121.6 50.4S684 316.1 684 362c0 45.9-17.9 89.1-50.4 121.6S557.9 534 512 534z"}}]},name:"user",theme:"outlined"};function I(){return I=Object.assign?Object.assign.bind():function(a){for(var c=1;c<arguments.length;c++){var i=arguments[c];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(a[t]=i[t])}return a},I.apply(this,arguments)}const W=(a,c)=>m.createElement(b,I({},a,{ref:c,icon:F})),k=m.forwardRef(W);function x(){return x=Object.assign?Object.assign.bind():function(a){for(var c=1;c<arguments.length;c++){var i=arguments[c];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(a[t]=i[t])}return a},x.apply(this,arguments)}const B=(a,c)=>m.createElement(b,x({},a,{ref:c,icon:P})),H=m.forwardRef(B),L="_container_5mrj0_1",z="_messageContainer_5mrj0_7",J="_message_5mrj0_7",q="_sent_5mrj0_29",G="_received_5mrj0_34",K="_system_5mrj0_39",Q="_messageHeader_5mrj0_46",V="_userId_5mrj0_53",X="_messageTime_5mrj0_57",Y="_messageContent_5mrj0_63",Z="_status_5mrj0_68",ee="_statusDot_5mrj0_75",se="_connected_5mrj0_81",te="_disconnected_5mrj0_85",ne="_controls_5mrj0_89",n={container:L,messageContainer:z,message:J,sent:q,received:G,system:K,messageHeader:Q,userId:V,messageTime:X,messageContent:Y,status:Z,statusDot:ee,connected:se,disconnected:te,controls:ne},{Title:re,Paragraph:oe,Text:y}=N;function Ce(){const[a]=h.useForm(),[c,i]=m.useState([]),[t,g]=m.useState(!1),[w,d]=m.useState(!1),[p,f]=m.useState(""),l=m.useRef(),u=m.useRef(null),O=()=>{const s=localStorage.getItem("wsUserId");if(s)return s;const r=Math.random().toString(36).substr(2,9);return localStorage.setItem("wsUserId",r),r},S=()=>{l.current&&l.current.close(),d(!0);const s=O();f(s),l.current=new WebSocket(`ws://localhost:3001?userId=${s}`),l.current.onopen=()=>{d(!1),g(!0)},l.current.onmessage=r=>{try{const o=JSON.parse(r.data);if(o.type==="error"){console.error("连接错误:",o.content),i(_=>[..._,{type:"system",content:o.content,userId:"system",timestamp:new Date().toISOString()}]),o.code==="DUPLICATE_ID"&&(localStorage.removeItem("wsUserId"),v());return}o.type==="system"&&o.content==="连接成功"&&f(s),o.type==="history"?i(o.messages):i(_=>[..._,o]),setTimeout(()=>{u.current&&(u.current.scrollTop=u.current.scrollHeight)},100)}catch(o){console.error("消息解析错误:",o)}},l.current.onclose=()=>{g(!1),d(!1),f(""),i(r=>[...r,{type:"system",content:"WebSocket 连接已断开",userId:"system",timestamp:new Date().toISOString()}])},l.current.onerror=()=>{g(!1),d(!1),i(r=>[...r,{type:"system",content:"WebSocket 连接发生错误",userId:"system",timestamp:new Date().toISOString()}])}};m.useEffect(()=>(S(),()=>{l.current?.close()}),[]);const j=async()=>{try{const{message:s}=await a.validateFields();if(!s.trim())return;const r={type:"chat",content:s,timestamp:new Date().toISOString()};l.current?.send(JSON.stringify(r)),a.resetFields()}catch(s){console.error("发送消息失败:",s)}},R=()=>{l.current?.close()},v=()=>{S()},D=s=>{const r=s.userId===p,o=s.type==="system";return e.jsxs("div",{className:`${n.message} ${o?n.system:r?n.sent:n.received}`,children:[!o&&e.jsxs("div",{className:n.messageHeader,children:[e.jsx(A,{size:"small",icon:e.jsx(H,{}),style:{backgroundColor:r?"#1890ff":"#52c41a"}}),e.jsx(y,{type:"secondary",className:n.userId,children:r?"我":`用户 ${s.userId}`})]}),e.jsx("div",{className:n.messageTime,children:new Date(s.timestamp).toLocaleTimeString()}),e.jsx("div",{className:n.messageContent,children:s.content})]},s.timestamp)};return e.jsx("div",{className:n.container,children:e.jsxs(T,{children:[e.jsx(re,{level:2,children:"WebSocket 聊天室"}),e.jsx(oe,{children:"这是一个多用户实时聊天室，支持用户之间的实时通信。"}),e.jsxs("div",{className:n.status,children:[e.jsx("div",{className:`${n.statusDot} ${t?n.connected:n.disconnected}`}),e.jsx(y,{children:t?"已连接":"未连接"}),p&&e.jsxs(y,{type:"secondary",style:{marginLeft:8},children:["我的ID: ",p]})]}),e.jsx("div",{className:n.controls,children:e.jsx(C,{type:"primary",danger:t,loading:w,icon:t?e.jsx(U,{}):e.jsx(k,{}),onClick:t?R:v,children:t?"断开连接":"重新连接"})}),e.jsx(h,{form:a,onFinish:j,children:e.jsxs($.Compact,{style:{width:"100%"},children:[e.jsx(h.Item,{name:"message",style:{flex:1,marginBottom:0},rules:[{required:!0,message:"请输入消息内容"}],children:e.jsx(E,{placeholder:"输入要发送的消息",onPressEnter:j,disabled:!t})}),e.jsx(C,{type:"primary",icon:e.jsx(M,{}),onClick:j,disabled:!t,children:"发送"})]})}),e.jsx("div",{className:n.messageContainer,ref:u,children:c.map(D)})]})})}export{Ce as default};
