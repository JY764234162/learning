import{r as o,I as v,d as C,j as e,T as b,B as S}from"../../main-DbH5S2Ei.js";import{F as h}from"./index-BgubNKz9.js";import{C as N}from"./index-C0FI_9Lj.js";import{R as O}from"./DisconnectOutlined-DXd--SHC.js";import{S as T}from"./index-bkJUHxLg.js";import{I as $}from"./index-Cktzoj0f.js";import{R as k}from"./SendOutlined-D_R5cLwY.js";import{A as E}from"./index-CwNF04E8.js";import"./row-DWGUlJ7t.js";import"./index-ZITYX-4z.js";import"./useBreakpoint-DGULg-N0.js";import"./useForceUpdate-DNSgzIuY.js";import"./ExclamationCircleFilled-pGhjSjAK.js";import"./Input-DZ8y3s0f.js";import"./EyeOutlined-BdMG4knG.js";import"./SearchOutlined-B_j3nuJ4.js";import"./index-wLqZGEG-.js";var M={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M909.1 209.3l-56.4 44.1C775.8 155.1 656.2 92 521.9 92 290 92 102.3 279.5 102 511.5 101.7 743.7 289.8 932 521.9 932c181.3 0 335.8-115 394.6-276.1 1.5-4.2-.7-8.9-4.9-10.3l-56.7-19.5a8 8 0 00-10.1 4.8c-1.8 5-3.8 10-5.9 14.9-17.3 41-42.1 77.8-73.7 109.4A344.77 344.77 0 01655.9 829c-42.3 17.9-87.4 27-133.8 27-46.5 0-91.5-9.1-133.8-27A341.5 341.5 0 01279 755.2a342.16 342.16 0 01-73.7-109.4c-17.9-42.4-27-87.4-27-133.9s9.1-91.5 27-133.9c17.3-41 42.1-77.8 73.7-109.4 31.6-31.6 68.4-56.4 109.3-73.8 42.3-17.9 87.4-27 133.8-27 46.5 0 91.5 9.1 133.8 27a341.5 341.5 0 01109.3 73.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.6 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c-.1-6.6-7.8-10.3-13-6.2z"}}]},name:"reload",theme:"outlined"},A=function(d,a){return o.createElement(v,C({},d,{ref:a,icon:M}))},F=o.forwardRef(A),W={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M858.5 763.6a374 374 0 00-80.6-119.5 375.63 375.63 0 00-119.5-80.6c-.4-.2-.8-.3-1.2-.5C719.5 518 760 444.7 760 362c0-137-111-248-248-248S264 225 264 362c0 82.7 40.5 156 102.8 201.1-.4.2-.8.3-1.2.5-44.8 18.9-85 46-119.5 80.6a375.63 375.63 0 00-80.6 119.5A371.7 371.7 0 00136 901.8a8 8 0 008 8.2h60c4.4 0 7.9-3.5 8-7.8 2-77.2 33-149.5 87.8-204.3 56.7-56.7 132-87.9 212.2-87.9s155.5 31.2 212.2 87.9C779 752.7 810 825 812 902.2c.1 4.4 3.6 7.8 8 7.8h60a8 8 0 008-8.2c-1-47.8-10.9-94.3-29.5-138.2zM512 534c-45.9 0-89.1-17.9-121.6-50.4S340 407.9 340 362c0-45.9 17.9-89.1 50.4-121.6S466.1 190 512 190s89.1 17.9 121.6 50.4S684 316.1 684 362c0 45.9-17.9 89.1-50.4 121.6S557.9 534 512 534z"}}]},name:"user",theme:"outlined"},B=function(d,a){return o.createElement(v,C({},d,{ref:a,icon:W}))},H=o.forwardRef(B);const L="_container_5mrj0_1",z="_messageContainer_5mrj0_7",P="_message_5mrj0_7",J="_sent_5mrj0_29",q="_received_5mrj0_34",G="_system_5mrj0_39",K="_messageHeader_5mrj0_46",Q="_userId_5mrj0_53",V="_messageTime_5mrj0_57",X="_messageContent_5mrj0_63",Y="_status_5mrj0_68",Z="_statusDot_5mrj0_75",ee="_connected_5mrj0_81",se="_disconnected_5mrj0_85",te="_controls_5mrj0_89",t={container:L,messageContainer:z,message:P,sent:J,received:q,system:G,messageHeader:K,userId:Q,messageTime:V,messageContent:X,status:Y,statusDot:Z,connected:ee,disconnected:se,controls:te},{Title:re,Paragraph:ne,Text:y}=b;function Se(){const[m]=h.useForm(),[d,a]=o.useState([]),[i,g]=o.useState(!1),[w,l]=o.useState(!1),[p,f]=o.useState(""),c=o.useRef(),u=o.useRef(null),R=()=>{const s=localStorage.getItem("wsUserId");if(s)return s;const r=Math.random().toString(36).substr(2,9);return localStorage.setItem("wsUserId",r),r},I=()=>{c.current&&c.current.close(),l(!0);const s=R();f(s),c.current=new WebSocket(`ws://localhost:3001?userId=${s}`),c.current.onopen=()=>{l(!1),g(!0)},c.current.onmessage=r=>{try{const n=JSON.parse(r.data);if(n.type==="error"){console.error("连接错误:",n.content),a(j=>[...j,{type:"system",content:n.content,userId:"system",timestamp:new Date().toISOString()}]),n.code==="DUPLICATE_ID"&&(localStorage.removeItem("wsUserId"),x());return}n.type==="system"&&n.content==="连接成功"&&f(s),n.type==="history"?a(n.messages):a(j=>[...j,n]),setTimeout(()=>{u.current&&(u.current.scrollTop=u.current.scrollHeight)},100)}catch(n){console.error("消息解析错误:",n)}},c.current.onclose=()=>{g(!1),l(!1),f(""),a(r=>[...r,{type:"system",content:"WebSocket 连接已断开",userId:"system",timestamp:new Date().toISOString()}])},c.current.onerror=()=>{g(!1),l(!1),a(r=>[...r,{type:"system",content:"WebSocket 连接发生错误",userId:"system",timestamp:new Date().toISOString()}])}};o.useEffect(()=>(I(),()=>{c.current?.close()}),[]);const _=async()=>{try{const{message:s}=await m.validateFields();if(!s.trim())return;const r={type:"chat",content:s,timestamp:new Date().toISOString()};c.current?.send(JSON.stringify(r)),m.resetFields()}catch(s){console.error("发送消息失败:",s)}},D=()=>{c.current?.close()},x=()=>{I()},U=s=>{const r=s.userId===p,n=s.type==="system";return e.jsxs("div",{className:`${t.message} ${n?t.system:r?t.sent:t.received}`,children:[!n&&e.jsxs("div",{className:t.messageHeader,children:[e.jsx(E,{size:"small",icon:e.jsx(H,{}),style:{backgroundColor:r?"#1890ff":"#52c41a"}}),e.jsx(y,{type:"secondary",className:t.userId,children:r?"我":`用户 ${s.userId}`})]}),e.jsx("div",{className:t.messageTime,children:new Date(s.timestamp).toLocaleTimeString()}),e.jsx("div",{className:t.messageContent,children:s.content})]},s.timestamp)};return e.jsx("div",{className:t.container,children:e.jsxs(N,{children:[e.jsx(re,{level:2,children:"WebSocket 聊天室"}),e.jsx(ne,{children:"这是一个多用户实时聊天室，支持用户之间的实时通信。"}),e.jsxs("div",{className:t.status,children:[e.jsx("div",{className:`${t.statusDot} ${i?t.connected:t.disconnected}`}),e.jsx(y,{children:i?"已连接":"未连接"}),p&&e.jsxs(y,{type:"secondary",style:{marginLeft:8},children:["我的ID: ",p]})]}),e.jsx("div",{className:t.controls,children:e.jsx(S,{type:"primary",danger:i,loading:w,icon:i?e.jsx(O,{}):e.jsx(F,{}),onClick:i?D:x,children:i?"断开连接":"重新连接"})}),e.jsx(h,{form:m,onFinish:_,children:e.jsxs(T.Compact,{style:{width:"100%"},children:[e.jsx(h.Item,{name:"message",style:{flex:1,marginBottom:0},rules:[{required:!0,message:"请输入消息内容"}],children:e.jsx($,{placeholder:"输入要发送的消息",onPressEnter:_,disabled:!i})}),e.jsx(S,{type:"primary",icon:e.jsx(k,{}),onClick:_,disabled:!i,children:"发送"})]})}),e.jsx("div",{className:t.messageContainer,ref:u,children:d.map(U)})]})})}export{Se as default};
